'use client'

import { useState, useRef, useEffect } from 'react'
import { MapPin, Search, Building, Loader2 } from 'lucide-react'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent } from '@/components/ui/card'
import { fetchAutocomplete, transformToAutocompleteItems, AutocompleteItem } from '@/lib/api'

// Hotel city type based on API response
interface HotelCity {
  id: number
  name: string
  country: string
  stateProvince: string
  countryCode: string
  type: string
}

// Popular Indian cities for initial display
const POPULAR_INDIAN_CITIES = [
  'Mumbai', 'Delhi', 'Bangalore', 'Kolkata', 'Chennai', 'Hyderabad',
  'Pune', 'Ahmedabad', 'Jaipur', 'Goa', 'Kochi', 'Thiruvananthapuram',
  'Guwahati', 'Lucknow', 'Chandigarh', 'Indore', 'Coimbatore', 'Varanasi',
  'Udaipur', 'Amritsar', 'Agra', 'Srinagar', 'Manali', 'Shimla', 'Darjeeling'
]

// Popular international destinations
const POPULAR_INTERNATIONAL_CITIES = [
  'Dubai', 'Singapore', 'Bangkok', 'Kuala Lumpur', 'Maldives',
  'Bali', 'Phuket', 'Kathmandu', 'Colombo', 'London', 'Paris',
  'New York', 'Tokyo', 'Sydney', 'Toronto', 'Zurich', 'Amsterdam'
]

// Get popular cities from our hotel cities data
const POPULAR_CITIES: HotelCity[] = [
  ...POPULAR_INDIAN_CITIES.map(name => 
    ALL_HOTEL_CITIES.find(c => c.name === name && c.country === 'India')
  ),
  ...POPULAR_INTERNATIONAL_CITIES.map(name => 
    ALL_HOTEL_CITIES.find(c => c.name === name)
  )
].filter((c): c is HotelCity => c !== undefined)

interface HotelCitySelectorProps {
  label?: string
  value: string
  onChange: (city: string) => void
  placeholder?: string
  className?: string
  disabled?: boolean
}

export function HotelCitySelector({ 
  label = "City, Property Name Or Location",
  value, 
  onChange, 
  placeholder = "Search cities or hotels...",
  className = "",
  disabled = false
}: HotelCitySelectorProps) {
  const [isOpen, setIsOpen] = useState(false)
  const [searchTerm, setSearchTerm] = useState(value || '')
  const [filteredCities, setFilteredCities] = useState<HotelCity[]>(POPULAR_CITIES)
  const [isLoading, setIsLoading] = useState(false)
  const containerRef = useRef<HTMLDivElement>(null)

  // Debounced search function
  useEffect(() => {
    const timeoutId = setTimeout(() => {
      if (searchTerm.length === 0) {
        setFilteredCities(POPULAR_CITIES)
        setIsLoading(false)
      } else if (searchTerm.length < 2) {
        // For single character, search only popular cities
        const filtered = POPULAR_CITIES.filter(city =>
          city.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          city.country.toLowerCase().includes(searchTerm.toLowerCase())
        )
        setFilteredCities(filtered)
        setIsLoading(false)
      } else {
        // For 2+ characters, search all cities with loading state
        setIsLoading(true)
        
        // Simulate a small delay for better UX
        setTimeout(() => {
          const filtered = ALL_HOTEL_CITIES.filter(city =>
            city.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            city.country.toLowerCase().includes(searchTerm.toLowerCase()) ||
            (city.stateProvince && city.stateProvince.toLowerCase().includes(searchTerm.toLowerCase()))
          ).slice(0, 100) // Limit to 100 results for performance
          
          setFilteredCities(filtered)
          setIsLoading(false)
        }, 150)
      }
    }, 200)

    return () => clearTimeout(timeoutId)
  }, [searchTerm])

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false)
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  useEffect(() => {
    // Update search term when value prop changes
    setSearchTerm(value || '')
  }, [value])

  const handleInputChange = (inputValue: string) => {
    setSearchTerm(inputValue)
    setIsOpen(true)
    onChange(inputValue) // Update parent with typed value
  }

  const handleCitySelect = (city: HotelCity) => {
    const cityName = city.name
    setSearchTerm(cityName)
    onChange(cityName)
    setIsOpen(false)
  }

  const handleInputFocus = () => {
    setIsOpen(true)
  }

  const getCountryFlag = (countryCode: string) => {
    // Simple flag emoji mapping for common countries
    const flags: Record<string, string> = {
      'IN': '🇮🇳',
      'US': '🇺🇸',
      'GB': '🇬🇧',
      'AU': '🇦🇺',
      'CA': '🇨🇦',
      'DE': '🇩🇪',
      'FR': '🇫🇷',
      'IT': '🇮🇹',
      'ES': '🇪🇸',
      'JP': '🇯🇵',
      'CN': '🇨🇳',
      'KR': '🇰🇷',
      'SG': '🇸🇬',
      'TH': '🇹🇭',
      'MY': '🇲🇾',
      'ID': '🇮🇩',
      'PH': '🇵🇭',
      'VN': '🇻🇳',
      'AE': '🇦🇪',
      'SA': '🇸🇦',
      'EG': '🇪🇬',
      'ZA': '🇿🇦',
      'BR': '🇧🇷',
      'AR': '🇦🇷',
      'MX': '🇲🇽',
      'RU': '🇷🇺',
      'TR': '🇹🇷',
      'NL': '🇳🇱',
      'CH': '🇨🇭',
      'AT': '🇦🇹',
      'BE': '🇧🇪',
      'SE': '🇸🇪',
      'NO': '🇳🇴',
      'DK': '🇩🇰',
      'FI': '🇫🇮',
      'PL': '🇵🇱',
      'CZ': '🇨🇿',
      'HU': '🇭🇺',
      'GR': '🇬🇷',
      'PT': '🇵🇹',
      'IE': '🇮🇪',
      'NZ': '🇳🇿',
      'LK': '🇱🇰',
      'BD': '🇧🇩',
      'PK': '🇵🇰',
      'NP': '🇳🇵',
      'BT': '🇧🇹',
      'MV': '🇲🇻',
      'MV': '🇲🇻'
    }
    return flags[countryCode] || '🌍'
  }

  return (
    <div ref={containerRef} className={`relative ${className}`}>
      <Label htmlFor="hotel-city-destination" className="text-slate-600 mb-2 block">
        {label}
      </Label>
      <div className="relative">
        <MapPin className="absolute left-3 top-3 h-4 w-4 text-slate-400" />
        <Input
          id="hotel-city-destination"
          placeholder={placeholder}
          value={searchTerm}
          onChange={(e) => handleInputChange(e.target.value)}
          onFocus={handleInputFocus}
          className="pl-10"
          disabled={disabled}
        />
        {isLoading && (
          <div className="absolute right-3 top-3">
            <Loader2 className="h-4 w-4 text-slate-400 animate-spin" />
          </div>
        )}
        {isOpen && !disabled && (
          <Card className="absolute z-50 mt-1 w-full shadow-lg max-h-96 overflow-y-auto">
            <CardContent className="p-0">
              {filteredCities.length > 0 ? (
                <div className="py-2">
                  {/* Group by country for better UX */}
                  {filteredCities.reduce((acc, city) => {
                    const country = city.country
                    if (!acc[country]) {
                      acc[country] = []
                    }
                    acc[country].push(city)
                    return acc
                  }, {} as Record<string, HotelCity[]>).India && (
                    <>
                      <div className="px-4 py-2 bg-slate-50 border-b border-slate-200">
                        <p className="text-xs font-semibold text-slate-500 uppercase">🇮🇳 India</p>
                      </div>
                      {filteredCities.filter(c => c.country === 'India').map((city) => (
                        <button
                          key={`${city.name}-${city.id}`}
                          type="button"
                          onClick={() => handleCitySelect(city)}
                          className="w-full px-4 py-3 text-left hover:bg-slate-50 focus:bg-slate-50 focus:outline-none border-b border-slate-100 last:border-b-0"
                        >
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <p className="font-medium text-slate-900">{city.name}</p>
                              <p className="text-xs text-slate-500 mt-0.5">
                                <Building className="inline h-3 w-3 mr-1" />
                                {city.stateProvince ? `${city.stateProvince}, India` : 'Hotels & Resorts'}
                              </p>
                            </div>
                            <span className="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded ml-2">
                              {city.id}
                            </span>
                          </div>
                        </button>
                      ))}
                    </>
                  )}
                  {filteredCities.filter(c => c.country !== 'India').length > 0 && (
                    <>
                      <div className="px-4 py-2 bg-slate-50 border-b border-slate-200">
                        <p className="text-xs font-semibold text-slate-500 uppercase">🌍 International</p>
                      </div>
                      {filteredCities.filter(c => c.country !== 'India').map((city) => (
                        <button
                          key={`${city.name}-${city.id}`}
                          type="button"
                          onClick={() => handleCitySelect(city)}
                          className="w-full px-4 py-3 text-left hover:bg-slate-50 focus:bg-slate-50 focus:outline-none border-b border-slate-100 last:border-b-0"
                        >
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <div className="flex items-center gap-2">
                                <p className="font-medium text-slate-900">{city.name}</p>
                                <span className="text-xs text-slate-500">
                                  {getCountryFlag(city.countryCode)} {city.country}
                                </span>
                              </div>
                              <p className="text-xs text-slate-500 mt-0.5">
                                <Building className="inline h-3 w-3 mr-1" />
                                {city.stateProvince ? `${city.stateProvince}` : 'Hotels & Resorts'}
                              </p>
                            </div>
                            <span className="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded ml-2">
                              {city.id}
                            </span>
                          </div>
                        </button>
                      ))}
                    </>
                  )}
                </div>
              ) : (
                <div className="px-4 py-8 text-center text-slate-500">
                  <Search className="h-8 w-8 mx-auto mb-2 text-slate-300" />
                  <p>No cities found</p>
                  <p className="text-sm">Try searching with city name or country</p>
                </div>
              )}
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  )
}
